name: Perform a code review when a pull request is created.
on:
  pull_request:
    types: [opened]

jobs:
  codex:
    environment: develop
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      final_message: ${{ steps.run_codex.outputs.final-message }}
    steps:
      - uses: actions/checkout@v5
        with:
          # Explicitly check out the PR's merge commit.
          ref: refs/pull/${{ github.event.pull_request.number }}/merge

      - name: Pre-fetch base and head refs for the PR
        run: |
          git fetch --no-tags origin \
            ${{ github.event.pull_request.base.ref }} \
            +refs/pull/${{ github.event.pull_request.number }}/head

      - name: Run Codex
        id: run_codex
        uses: openai/codex-action@v1.4
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          # Command to control version of Codex to use
          # codex-version: "0.80.0"
          prompt: |
            You are an experienced senior engineer reviewing a React, PhaserJS, and TypeScript codebase that uses **React Compiler** in production.

            This is PR #${{ github.event.pull_request.number }} for ${{ github.repository }}.
            Base SHA: ${{ github.event.pull_request.base.sha }}
            Head SHA: ${{ github.event.pull_request.head.sha }}

            Your job:
            - Review **only** the changes introduced by this PR (the diff between base and head).
            - Ensure the code is:
              - Correct and maintainable
              - Safe for React Compiler
              - Following modern React best practices
              - Performance-conscious and production-ready
              - Does not introduce new bugs or regressions
              - Follows the project's coding standards and conventions

            The project assumptions:
            - React 19+ with React Compiler enabled.
            - Components are expected to be **pure** and compatible with concurrent rendering.
            - Code is expected to be performant and production-ready.

            When reviewing, focus on:

            1) React correctness & React Compiler compatibility
            - Components must be **pure**:
              - No side effects in render.
              - No non-deterministic work in render (e.g. `Date.now()`, `new Date()`, `Math.random()`, `performance.now()`, or reading from `window`, `document`, `localStorage`, etc.).
            - Hooks:
              - Follow the Rules of Hooks (called unconditionally, top-level only, no loops/conditions).
              - Dependency arrays should be correct and minimal (no missing or unnecessary deps).
              - Avoid patterns that could break under React Compiler’s assumptions.
            - State & refs:
              - Avoid “mirroring” props or external values into state unless there is a strong reason.
              - Prefer deriving values directly from props or selectors instead of duplicating them in state.
              - Avoid reading/writing mutable refs or other mutable singletons in render in a way that affects UI logic.
            - Components:
              - Avoid defining components inside other components (nested component definitions) unless there is a clear, intentional reason and it’s safe for React Compiler.

            2) Performance & allocation patterns
            - Avoid heavy or repeated work in render (e.g. expensive loops, sorting, filtering, allocations).
            - Watch for unnecessary allocations that can cause extra renders:
              - New object/array literals used directly as props.
              - Inline arrow functions that should be memoized with `useCallback` when passed deep or frequently.
            - Check list rendering:
              - Keys should be stable and not derived from array index unless truly safe.
            - Suggest `useMemo`, `useCallback`, or moving work outside components when it meaningfully improves performance or React Compiler friendliness.
            - Follows PhaserJS best practices and patterns.

            3) Robustness, safety & TypeScript quality
            - Null/undefined checks, edge cases, and boundary conditions.
            - Async behaviour:
              - Effects should clean up properly (subscriptions, timers, listeners, etc.).
              - No logic that relies on effects running a specific number of times.
            - TypeScript:
              - Avoid unnecessary `any`, unsafe casts, or overly broad types.
              - Prefer precise types that make illegal states unrepresentable when practical.

            4) Behavioural parity after compilation
            - Call out any code that might behave differently once React Compiler optimizes it:
              - Logic that depends on render being called a specific number of times.
              - Code that relies on object/closure identity across renders in fragile ways.
              - Any effect or state logic that might break with aggressive memoization or reordering.

            Output format:
            - Start with a short **Summary** (2–5 bullet points).
            - Then list findings grouped by category with severity tags:
              - `[High]` – likely bug, production risk, or serious React/Compiler issue.
              - `[Medium]` – potential bug, performance issue, or confusing pattern.
              - `[Low]` – minor readability/cleanup suggestion.
            - When possible, reference file and line in the diff (e.g. `src/foo/Bar.tsx:42`).
            - For each issue, give a **specific** suggestion or small code sketch for how to improve it.
            - If the PR looks great, explicitly say so and only mention a few small nits that would clearly improve clarity or performance.

            Pull request title and body:
            ----
            ${{ github.event.pull_request.title }}
            ${{ github.event.pull_request.body }}

  post_feedback:
    runs-on: ubuntu-latest
    needs: codex
    if: needs.codex.outputs.final_message != ''
    # permissions:
    #   issues: write
    #   pull-requests: write
    steps:
      - name: Report Codex feedback
        uses: actions/github-script@v7
        env:
          CODEX_FINAL_MESSAGE: ${{ needs.codex.outputs.final_message }}
        with:
          github-token: ${{ github.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: process.env.CODEX_FINAL_MESSAGE,
            });
