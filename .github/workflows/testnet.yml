name: Testnet deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    concurrency: testnet-deploy
    environment: develop
    runs-on: ubuntu-latest
    steps:
      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-%dT%H:%M')"

      - name: Get the current version ref
        id: get_version
        run: echo ::set-output name=VERSION::${GITHUB_SHA}

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: yarn install

      - name: Build
        run: yarn build
        env:
          NODE_OPTIONS: --max-old-space-size=6144
          CI: false

          VITE_API_URL: ${{ secrets.API_URL }}
          VITE_ROOM_URL: ${{ secrets.ROOM_URL }}
          VITE_DONATION_ADDRESS: ${{ secrets.DONATION_ADDRESS }}
          VITE_NETWORK: amoy
          VITE_ACCOUNT_MINTER_CONTRACT: "0xf1ec7a4b75e8A2aC42A47e4c1bbBC0882543B4E4"
          VITE_POKO_ACCOUNT_MINTER_CONTRACT: "0xf1ec7a4b75e8A2aC42A47e4c1bbBC0882543B4E4"
          VITE_SESSION_CONTRACT: "0x91083eE5761D5b0C286AB6bfb1E73E5895EaBe22"
          VITE_AUCTION_CONTRACT: "0x4AF3425117D7D50f84aA300cc6EF72a1211f543F"
          VITE_GAME_CONTRACT: "0x05BbC2c442A7468538e68B1F70a97C9140227b0e"
          VITE_FARM_CONTRACT: "0x6E625972Ca5206Ae213650CDc10fba1878540352"
          VITE_INVENTORY_CONTRACT: "0xAF9f4013b569A69Ed43DB368598B37fE08fa3520"
          VITE_TOKEN_CONTRACT: "0x64C865248a4ba3E9993F0c948246C0cC17E50F8F"
          VITE_WITHDRAWAL_CONTRACT: "0x2563436C24B5798B24df9F6BD2f72c13d9Efa48e"
          VITE_WISHING_WELL_CONTRACT: "0x4B6176fACF562A68258980863f1188941f734248"
          VITE_PAIR_CONTRACT: "0x000000000000000000000000000000000000dEaD"
          VITE_TRADER_CONTRACT: "0x00733B03b6f3Ae6Ed195B369ddac47FF903f123f"
          VITE_TREASURY_ADDRESS: "0x1DB57407EE80709D4d862fe81399FBB35B8B9586"
          VITE_BUMPKIN_DETAILS_CONTRACT: "0xD35D367B7268fec464DBbD2a8cDFCF2fe993C688"
          VITE_BUMPKIN_ITEMS_CONTRACT: "0x8184641F9E132Ff28077E9C1C2e36BB98106e254"
          VITE_BUMPKIN_CONTRACT: "0x9141AAc3CF88C8545a7F7C0e51cA62BD9b5AAC4b"
          VITE_DISCORD_REDIRECT: "https://sunflower-land.com/testnet/"
          VITE_CLIENT_VERSION: ${{ steps.date.outputs.date }}
          VITE_RELEASE_VERSION: ${{ steps.get_version.outputs.VERSION }}
          VITE_RECAPTCHA_SITEKEY: "6Lfqm6MeAAAAAFS5a0vwAfTGUwnlNoHziyIlOl1s"
          VITE_CLOUDFLARE_CAPTCHA_SITEKEY: "0x4AAAAAAAAoHFfoj3YbRYSO"
          VITE_FROG_CONTRACT: "0x000000000000000000000000000000000000dEaD"
          VITE_FROG_DONATION: "0x000000000000000000000000000000000000dEaD"
          VITE_TADPOLE_CONTRACT: "0x000000000000000000000000000000000000dEaD"
          VITE_INCUBATOR_CONTRACT: "0x000000000000000000000000000000000000dEaD"
          VITE_WHITELIST_TOKEN_CONTRACT: "0x000000000000000000000000000000000000dEaD"
          VITE_QUEST_CONTRACT: "0xB7C85B0A62BF284168Cdb33126Fc987AeD728323"
          VITE_SEAL_CONTRACT: "0x000000000000000000000000000000000000dEaD"
          VITE_BUY_SFL_CONTRACT: "0x4196d162B9d4Bd3C31e64284A4E5f58c2cDb90FE"
          VITE_BUY_BLOCK_BUCKS_CONTRACT: "0x943Cd0BcF09c7dDf2CA9Fe115B530A4B3FCFc436"
          VITE_DEPOSIT_CONTRACT: "0x05c63E157969C8a92e5E4591223705C9134F57b1"
          VITE_BUD_DEPOSIT_CONTRACT: "0x000000000000000000000000000000000000dEaD"
          VITE_QUICKSWAP_ROUTER_CONTRACT: "0x000000000000000000000000000000000000dEaD"
          VITE_WMATIC_CONTRACT: "0x000000000000000000000000000000000000dEaD"
          VITE_GREEDY_GOBLIN_DONATION: "0x7bC6Fe738E5f4FdCbd034489A0320507BCA9806D"
          VITE_CHICKEN_FIGHT_DONATION: "0x99B4E9Dc0b20E4A8a2D5be4145C38196A80e164B"
          VITE_DAILY_REWARD_CONTRACT: "0x50CEA29a39fF01E50F2317DFEb51caBDaf46477C"
          VITE_CHRISTMAS_EVENT_DONATION: "0xE336EF65aC5532C0BfeFF52e350B22F96E784b6F"

          VITE_BUD_CONTRACT: "0x5b6563e99A8FCafE125b6023D723E8d372e36E96"
          VITE_DEQUIPPER_CONTRACT: "0x1D14762E8A50E031e4Da3125c300a1D7370CBA4f"

          VITE_ALCHEMY_RPC: ${{ secrets.ALCHEMY_RPC }}
          VITE_POKO_API_KEY: ${{ secrets.POKO_API_KEY }}
          VITE_POKO_DIRECT_CHECKOUT_API_KEY: ${{ secrets.POKO_DIRECT_CHECKOUT_API_KEY }}
          VITE_WALLETCONNECT_PROJECT_ID: ${{ secrets.WALLETCONNECT_PROJECT_ID }}
          VITE_PRIVATE_IMAGE_URL: "https://sunflower-land.com/testnet-assets"
          VITE_GAME_ANALYTICS_APP_ID: ${{ secrets.GAME_ANALYTICS_APP_ID }}
          VITE_GAME_ANALYTICS_PUB_KEY: ${{ secrets.GAME_ANALYTICS_PUB_KEY }}
          VITE_SEQUENCE_ACCESS_KEY: ${{ secrets.SEQUENCE_ACCESS_KEY }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1.5.9
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-2

      - name: Deploy static site to S3 bucket
        run: aws s3 sync ./dist/ s3://sunflower-land.com/testnet --delete

      - name: Deploy static site to S3 bucket
        run: aws s3 sync ./dist/ s3://www.sunflower-land.com/testnet --delete

      - name: Invalidate CloudFront
        uses: chetan/invalidate-cloudfront-action@v2
        env:
          DISTRIBUTION: ${{ secrets.CF_DISTRIBUTION }}
          PATHS: "/testnet/*"
          AWS_REGION: "us-east-1"
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  update_release_draft:
    runs-on: ubuntu-latest
    steps:
      # Drafts your next Release notes as Pull Requests are merged into "master"
      - uses: release-drafter/release-drafter@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
